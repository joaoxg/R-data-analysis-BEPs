<<<<<<< HEAD
"ave_mortgage" = "Mortgage",
"ave_profit_minus_spent_savings_house_moving" = "House profit - Spent savings",
"ave_taxes" = "Taxes",
"ave_fluvial_damage" = "River damage",
"ave_pluvial_damage" = "Rain damage")
) +
guides(
fill = guide_legend(title = "Round costs"),
color = guide_legend(title = "Round Spendable Income")
) +
#Y-axis formatting
scale_y_continuous(
labels = function(y) y / 1000,
name = "Game Currency (k)"
) +
scale_x_continuous(
name = "Round income (k) \n Players per class",
breaks = c(1, 2, 3, 4, 5, 6),
labels = income_dist_x$label
) +
theme_minimal() +
theme(
axis.text.x = element_markdown(angle = 0, hjust = 0.5), ##takes rich html
plot.title = element_text(hjust = 0.5),
plot.subtitle = element_text(hjust = 0.5, size = 10),
plot.title.position = "plot"
)
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP2_vjcortesa_check errors.R")
plot <- ggplot() +
geom_area(data = area_income_formatted,
aes(x = Index, y = Value, fill = Type),
alpha = 0.6
) +
geom_bar(data = bars_expenses_formatted,
aes(x = Index, y = Value, fill = Type),
stat = "identity",
position = "stack",
width = w
) +
geom_line(
data = line_spendable,
aes(x = Index,
y = ave_Spendable,
color = "ave_Spendable"),
linewidth = 1.2) +
labs(
title = plot_title,
subtitle = plot_subtitle,
color = "Category"
) +
# Custom fill colors to what is plotted in the legend
scale_color_manual(
name = "Round Spendable \n Income",
values = c(
"ave_Spendable" = "black"),
labels = c(
"ave_Spendable" = "Round income - costs")
) +
scale_fill_manual(
name = "Round costs",
values = c(
"ave_income_minus_living" = "#E1BB70",
"ave_debt" = "black",
"ave_satisfaction" = "#dfaba3",
"ave_measures" = "white",
"ave_profit_minus_spent_savings_house_moving" =  "#a3a3a3",
"ave_mortgage" = "#cccccc",
"ave_taxes" = "#dddddd",
"ave_fluvial_damage" = "#79A2C5",
"ave_pluvial_damage" = "#79BCC5"),
labels = c(
"ave_income_minus_living" = "Income - Living costs",
"ave_debt" = "Debt",
"ave_satisfaction" = "Satisfaction",
"ave_measures" = "Measures",
"ave_mortgage" = "Mortgage",
"ave_profit_minus_spent_savings_house_moving" = "House profit - Spent savings",
"ave_taxes" = "Taxes",
"ave_fluvial_damage" = "River damage",
"ave_pluvial_damage" = "Rain damage")
) +
guides(
fill = guide_legend(title = "Round costs"),
color = guide_legend(title = "Round Spendable Income")
) +
#Y-axis formatting
scale_y_continuous(
labels = function(y) y / 1000,
name = "Game Currency (k)"
) +
scale_x_continuous(
name = "Round income (k) \n Players per class",
breaks = c(1, 2, 3, 4, 5, 6),
labels = income_dist_x$label
) +
theme_minimal() +
theme(
axis.text.x = element_markdown(angle = 0, hjust = 0.5), ##takes rich html
plot.title = element_text(hjust = 0.5),
plot.subtitle = element_text(hjust = 0.5, size = 10),
plot.title.position = "plot"
)
ggsave(plot_name, width = 12, height = 6, dpi = 300)
plot(plot)
print(getwd())
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP2_vjcortesa_check errors.R")
print(script_path)
script_path <- dirname(rstudioapi::getActiveDocumentContext()$path)
function_path <- file.path(script_path,"functions")
dataset_path <- file.path(dirname(script_path),"Datasets")
data_output_path <- file.path(script_path,"data_output")
fig_output_path <- file.path(script_path,"fig_output")
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP2_vjcortesa_check errors.R")
ggsave(
file.path(data_output_path,"myplot.png"),
plot = plot,
width = 12,
height = 6,
dpi = 300)
plot(plot)
print(plot_name)
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP2_vjcortesa_check errors.R")
ggsave(
file.path(fig_output_path,"myplot.png"),
plot = plot,
width = 12,
height = 6,
dpi = 300)
print(plot_name)
ggsave(
file.path(fig_output_path,plot_name),
plot = plot,
width = 12,
height = 6,
dpi = 300)
View(gamesession)
dataset_name <- str_extract(folder_name, "\\d+")
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP2_vjcortesa_check errors.R")
View(fdataset)
View(fdataset)
View(fdataset)
View(gamesession)
print(gamesession$gamesession_name)
dataset_name <- str_extract(gamesession$gamesession_name, "\\d+")
print(gamesession$gamesession_name)
print(dataset_name)
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP2_vjcortesa_How did players spend their money_check errors.R")
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP2_vjcortesa_How did players spend their money_check errors.R")
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP2_vjcortesa_How did players spend their money_check errors.R")
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP2_vjcortesa_check errors.R")
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP2_vjcortesa_check errors.R")
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP2_vjcortesa_check errors.R")
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP2_vjcortesa_check errors.R")
# Write to Excel with sheet names matching table names
write_xlsx(list_income_dist, "folder_name_income_dist.xlsx")
tryCatch({
write_xlsx(list_income_dist, file.path(data_output_path, paste0("Income_dist_", folder_name, ".xlsx")))
message("File written successfully.")
}, error = function(e) {
message("Error: ", e$message)
})
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP2_vjcortesa_check errors.R")
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP2_vjcortesa_check errors.R")
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP2_vjcortesa_check errors.R")
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP3_vjcortesa_Selected measures.R")
install.packages("systemfonts")
packageVersion("systemfonts")  # should be >= "1.3.1"
# Then try ggimage again:
install.packages("ggimage")
# Load necessary libraries
library(readxl)
library(readr)
# Load if using RStudio (interactive session)
library(rstudioapi)
# Load for database manipulation
library(sqldf)
# Load for data manipulation
library(dplyr)
library(stringr)
# Load for excel manipulation
library(writexl)
# Load for data visualisation
library(tidyr)
library(ggplot2)
library(ggtext)
library(plotly)
library(ggimage)
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP3_vjcortesa_Selected measures.R")
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP3_vjcortesa_Selected measures.R")
# Step 2: Horizontal stacked bar chart
plot <- ggplot(measures_combined_counts,
aes(x = short_alias,
y = count,
fill = groupround_round_number)) +
geom_bar(stat = "identity") +
scale_fill_manual(values = rounds_classes) +  # manual gray palette
labs(x = "Measure Type",
y = "Count",
fill = "Round Number") +
theme_minimal() +
coord_flip() +
theme(axis.text.x = element_text(angle = 0, hjust = 0.5))
# Convert ggplot to interactive plotly object
interactive_plot <- ggplotly(plot, tooltip = c("x", "y", "fill"))
interactive_plot
# Create the function for the plot
# Variables to create the
group <- "all"
round <- "all"
# Filter the dataset with all players plot
plot_player_all <- data.frame(player_code = c("t1p1", "t1p2", "t1p3", "t1p4", "t1p5", "t1p6" , "t1p7", "t1p8"),
selected = c(1, 1, 1, 1, 1, 1, 1, 1))
players <- plot_player_all
player_plot <- ""
# Set the factor level order based on measuretype$short_alias
measures_combined_counts$short_alias <- factor(
measures_combined_counts$short_alias,
levels = rev(measuretype$short_alias)
)
# Ensure every row in measures_combined_counts has the correct icon according to its short_alias
measures_combined_counts <- measures_combined_counts %>%
left_join(measuretype %>% select(short_alias, icons_path), by = "short_alias")
# Synchronise the label with the measure type and icon
measures_combined_counts$label <- paste0(
"<img src='", measures_combined_counts$icons_path, "' width='20'/> ",
measures_combined_counts$short_alias
)
print(measures_combined_counts$icons_path[1])
# On Windows, this should open the image in your default viewer
shell.exec(normalizePath(measures_combined_counts$icons_path[1], winslash = "/", mustWork = TRUE))
measuretype <- sqldf("
SELECT
m.short_alias,
m.cost_absolute,
m.cost_percentage_income,
m.cost_percentage_house,
mt.cost_reference,
mt.plot_order,
mt.icons_path
FROM measuretype AS m
LEFT JOIN measures_text AS mt
ON m.short_alias = mt.short_alias
ORDER BY
CASE
WHEN m.cost_absolute <> 0 THEN 1 ELSE 2
END,
m.cost_absolute DESC,
mt.plot_order
")
#create a new column in R that concatenates the absolute cost (if non‑zero) and the percentage cost (if non‑zero) together with the cost reference.
measuretype <- measuretype %>%
mutate(
cost_info = case_when(
cost_absolute != 0 ~ paste0(cost_absolute/1000),
cost_percentage_income != 0 ~ paste0(cost_percentage_income, "% income"),
cost_percentage_house != 0 ~ paste0(cost_percentage_house, "% house cost"),
TRUE ~ "No cost"
)
)
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP3_vjcortesa_Selected measures.R")
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP3_vjcortesa_exampleplot.R")
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP3_vjcortesa_exampleplot.R")
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP3_vjcortesa_exampleplot.R")
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP3_staticplot.R")
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP3_staticplot.R")
source("~/.active-rstudio-document")
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP3_vjcortesa_exampleplot.R")
rm(list = ls())
library(ggplot2)
library(plotly)
library(base64enc)
# --- Sample data (replace later with your measures_combined_counts) ---
df <- data.frame(
short_alias = c("A", "B", "C"),
groupround_round_number = c("1", "2", "3"),
count = c(10, 15, 8),
stringsAsFactors = FALSE
)
# --- Built-in or fallback image ---
rlogo_jpg <- file.path(R.home("doc"), "html", "logo.jpg")
if (!file.exists(rlogo_jpg)) {
# Fallback: make a tiny PNG so the test is self-contained
tmp_png <- file.path(tempdir(), "fallback_logo.png")
grDevices::png(tmp_png, width = 160, height = 160, bg = "white")
par(mar = c(0,0,0,0))
plot.new()
text(0.5, 0.5, "ICON", cex = 2)
grDevices::dev.off()
rlogo_jpg <- tmp_png
}
# --- Encode image to Base64 data URI ---
encode_base64 <- function(path){
ext  <- tolower(tools::file_ext(path))
mime <- if (ext %in% c("jpg","jpeg")) "image/jpeg" else "image/png"
raw  <- readBin(path, "raw", n = file.info(path)$size)
paste0("data:", mime, ";base64,", base64enc::base64encode(raw))
}
logo_src <- encode_base64(rlogo_jpg)
# Diagnostic: ensure we actually have payload
cat("Base64 length:", nchar(logo_src), "\n")  # should be > 1000 typically
# --- Build the plot and convert to plotly ---
p <- ggplot(df, aes(x = short_alias, y = count, fill = groupround_round_number)) +
geom_col() +
coord_flip() +
scale_fill_manual(values = c("1"="#e0e0e0","2"="#808080","3"="#1a1a1a")) +
labs(x = "Measure Type", y = "Count", fill = "Round Number") +
theme_minimal()
pl <- ggplotly(p, tooltip = c("x","y","fill"))
# --- Place ONE image at top-left using paper coords (0..1) ---
pl <- layout(pl, images = list(list(
source  = logo_src,
xref    = "paper", yref = "paper",
x       = 0.01,    y    = 0.99,       # near top-left corner
sizex   = 0.15,    sizey = 0.15,      # relative to figure size
xanchor = "left",  yanchor = "top",
layer   = "above"
)))
# PRINT IT (important in scripts)
pl
print(pl)
# Fallback: Open in your default browser if Viewer is blank
htmlwidgets::saveWidget(pl, file = file.path(tempdir(), "plotly_image_test.html"), selfcontained = TRUE)
browseURL(file.path(tempdir(), "plotly_image_test.html"))
# 1) Get a built-in image. Try the R logo; if missing, generate a quick PNG fallback
rlogo <- file.path(R.home("doc"), "html", "logo.jpg")
if (!file.exists(rlogo)) {
rlogo <- file.path(tempdir(), "built_icon.png")
grDevices::png(rlogo, width = 160, height = 160, bg = "white")
par(mar = c(0,0,0,0))
plot.new()
text(0.5, 0.5, "ICON", cex = 2)
grDevices::dev.off()
}
# 2) Encode the image as Base64 (robust across Viewer/browsers)
encode_b64 <- function(path) {
ext  <- tolower(tools::file_ext(path))
mime <- if (ext %in% c("jpg","jpeg")) "image/jpeg" else "image/png"
raw  <- readBin(path, "raw", n = file.info(path)$size)
paste0("data:", mime, ";base64,", base64enc::base64encode(raw))
}
icon_src <- encode_b64(rlogo)
# 3) Convert your ggplot to Plotly (no HTML in labels needed)
pl <- ggplotly(plot, tooltip = c("x", "y", "fill"))
library(plotly)
library(base64enc)
# 1) Get a built-in image. Try the R logo; if missing, generate a quick PNG fallback
rlogo <- file.path(R.home("doc"), "html", "logo.jpg")
if (!file.exists(rlogo)) {
rlogo <- file.path(tempdir(), "built_icon.png")
grDevices::png(rlogo, width = 160, height = 160, bg = "white")
par(mar = c(0,0,0,0))
plot.new()
text(0.5, 0.5, "ICON", cex = 2)
grDevices::dev.off()
}
# 2) Encode the image as Base64 (robust across Viewer/browsers)
encode_b64 <- function(path) {
ext  <- tolower(tools::file_ext(path))
mime <- if (ext %in% c("jpg","jpeg")) "image/jpeg" else "image/png"
raw  <- readBin(path, "raw", n = file.info(path)$size)
paste0("data:", mime, ";base64,", base64enc::base64encode(raw))
}
icon_src <- encode_b64(rlogo)
# 3) Convert your ggplot to Plotly (no HTML in labels needed)
pl <- ggplotly(plot, tooltip = c("x", "y", "fill"))
# Set the factor level order based on measuretype$short_alias
measures_combined_counts$short_alias <- factor(
measures_combined_counts$short_alias,
levels = rev(measuretype$short_alias)
)
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP3_vjcortesa_Selected measures.R")
interactive_plot <- ggplotly(plot, tooltip = c("x", "y", "fill"))
interactive_plot
View(measures_combined_counts)
# 1) Built-in image (R logo) or fallback PNG if logo is unavailable
rlogo <- file.path(R.home("doc"), "html", "logo.jpg")
if (!file.exists(rlogo)) {
rlogo <- file.path(tempdir(), "built_icon.png")
grDevices::png(rlogo, width = 160, height = 160, bg = "white")
par(mar = c(0,0,0,0)); plot.new(); text(0.5, 0.5, "ICON", cex = 2); grDevices::dev.off()
}
# 2) Helper: encode an image file to Base64 (reliable across environments)
encode_b64 <- function(path) {
ext  <- tolower(tools::file_ext(path))
mime <- if (ext %in% c("jpg","jpeg")) "image/jpeg" else "image/png"
raw  <- readBin(path, "raw", n = file.info(path)$size)
paste0("data:", mime, ";base64,", base64enc::base64encode(raw))
}
icon_src <- encode_b64(rlogo)
# 3) Convert ggplot to plotly
pl <- ggplotly(plot, tooltip = c("x", "y", "fill"))
# 4) Compute totals per category to get a sensible y range and positioning
totals <- measures_combined_counts %>%
group_by(short_alias) %>%
summarize(count = sum(count, na.rm = TRUE), .groups = "drop")
y_max <- max(totals$count, na.rm = TRUE)
# Position icons slightly to the LEFT of the bars (coord_flip -> x is category, y is numeric)
y_off <- -0.12 * y_max   # move ~12% left of zero; tweak to taste
# IMPORTANT: extend y-axis range so the negative offset is visible
pl <- layout(
pl,
yaxis = list(range = c(y_off * 1.5, y_max * 1.1)),  # more room on left/top
margin = list(l = 120)                               # extra left margin (optional)
)
# 5) Add ONE image per category at x=<category>, y=y_off
cats <- as.character(totals$short_alias)
images_list <- lapply(seq_along(cats), function(i) {
list(
source   = icon_src,
xref     = "x", yref = "y",
x        = cats[i],
y        = y_off,
sizex    = 0.5,       # tune sizes
sizey    = 0.5,
xanchor  = "center",
yanchor  = "middle",
layer    = "above"
)
})
pl <- layout(pl, images = images_list)
# 6) Render (explicit print helps when sourcing scripts)
pl
print(pl)
# If Viewer is blank, open in browser:
htmlwidgets::saveWidget(pl, file = file.path(tempdir(), "plotly_image_test.html"), selfcontained = TRUE)
browseURL(file.path(tempdir(), "plotly_image_test.html"))
# --- 1) Prepare data (use your measures_combined_counts as-is) ---
df <- measures_combined_counts %>%
mutate(groupround_round_number = as.factor(groupround_round_number))
# Ensure a consistent order (optional)
df$short_alias <- factor(df$short_alias, levels = rev(measuretype$short_alias))
# --- 2) Build the stacked bar chart directly with plotly ---
p <- plot_ly()
# Add one trace per round for stacking
round_levels <- levels(df$groupround_round_number)
round_colors <- c("1" = "#e0e0e0", "2" = "#b3b3b3", "3" = "#808080", "4" = "#4d4d4d", "5" = "#1a1a1a")
for (r in round_levels) {
sub <- df %>% filter(groupround_round_number == r)
p <- add_trace(
p,
type = "bar",
orientation = "h",             # horizontal bars
x = sub$count,                 # numeric axis
y = sub$short_alias,           # category axis
name = r,
marker = list(color = round_colors[[r]]),
hovertemplate = paste(
"Measure: %{y}<br>",
"Round: ", r, "<br>",
"Count: %{x}<extra></extra>"
)
)
}
p <- layout(
p,
barmode = "stack",
xaxis = list(title = "Count"),
yaxis = list(title = "Measure Type"),
legend = list(title = list(text = "Round Number")),
margin = list(l = 120)
)
# --- 3) Add one image per category (left of bars) using Base64 ---
# Helper to Base64-encode a local file
encode_b64 <- function(path) {
ext  <- tolower(tools::file_ext(path))
mime <- if (ext %in% c("jpg","jpeg")) "image/jpeg" else if (ext == "svg") "image/svg+xml" else "image/png"
raw  <- readBin(path, "raw", n = file.info(path)$size)
paste0("data:", mime, ";base64,", base64enc::base64encode(raw))
}
# Build mapping of category -> icon file (append .png if missing)
icon_map <- df %>%
select(short_alias, icons_path) %>%
distinct() %>%
mutate(icon_file = ifelse(grepl("\\.(png|jpg|jpeg|svg)$", icons_path, ignore.case = TRUE),
icons_path, paste0(icons_path, ".png"))) %>%
filter(file.exists(icon_file)) %>%
mutate(src = vapply(icon_file, encode_b64, FUN.VALUE = character(1)))
# Compute total per category to size/offset
totals <- df %>% group_by(short_alias) %>% summarize(total = sum(count, na.rm = TRUE), .groups = "drop")
x_max  <- max(totals$total, na.rm = TRUE)
x_off  <- -0.12 * x_max                    # place icons left of zero (tune this)
p <- layout(p, xaxis = list(range = c(x_off * 1.5, x_max * 1.1)))  # extend x range to show icons
# Create one image entry per category at (x_off, y = category)
images_list <- lapply(seq_len(nrow(icon_map)), function(i) {
list(
source   = icon_map$src[i],
xref     = "x", yref = "y",
x        = x_off,
y        = as.character(icon_map$short_alias[i]),
sizex    = 0.08 * x_max,      # size in x-units (tune)
sizey    = 0.8,               # proportion of category band height
xanchor  = "left",
yanchor  = "middle",
layer    = "above"
)
})
p <- layout(p, images = images_list)
# Render
p
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP3_vjcortesa_Selected measures.R")
View(measures_combined)
View(measuretype)
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP3_vjcortesa_Selected measures.R")
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP3_vjcortesa_Selected measures.R")
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP3_vjcortesa_Selected measures.R")
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP3_vjcortesa_Selected measures.R")
View(measures_combined_counts)
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP3_vjcortesa_Selected measures.R")
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP3_vjcortesa_Selected measures.R")
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP3_vjcortesa_Selected measures.R")
View(images_list)
View(icon_map)
=======
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/WWM_How did players spend their money_vjcortesa.R")
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/WWM_How did players spend their money_vjcortesa.R")
source("~/TUDelft/18_Game Data Analysis/R data analysis_24 dataset/250814_Ommen session_240924.R")
source("~/TUDelft/18_Game Data Analysis/R data analysis_24 dataset/250814_Ommen session_240924.R")
# Load necessary libraries
library(readxl)
source("~/TUDelft/18_Notebooks_071125/R data analysis_24 dataset/250814_Ommen session_240924.R")
source("~/TUDelft/18_Notebooks_071125/R data analysis_24 dataset/250814_Ommen session_240924.R")
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP2_vjcortesa_check errors.R")
print(script_dir_up)
github_path <- file.path(script_dir_up,"Scripts_vjcortesa")
print(github_path)
github_path <- file.path(dirname(dirname(script_path)),"Scripts_vjcortesa")
# Load required functions
script_path <- rstudioapi::getActiveDocumentContext()$path
github_path <- file.path(dirname(dirname(script_path)),"Scripts_vjcortesa")
# Load required functions
print(github_path)
script_path <- rstudioapi::getActiveDocumentContext()$path
function_path <- file.path(script_path,"functions")
print(function_path)
script_path <- rstudioapi::getActiveDocumentContext()$path
function_path <- file.path(dirname(script_path),"functions")
print(function_path)
script_path <- rstudioapi::getActiveDocumentContext()$path
function_path <- file.path(dirname(script_path),"functions")
dataset_path <- file.path(dirname(dirname(script_path)),"Dataset")
#function_path <- file.path(dirname(dirname(script_path)),"Scripts_vjcortesa")
# Load required functions
print(dataset_path)
# Get the path of the current script (works in RStudio),
# For example,  ".../R data analysis BEPs/Scripts_vjcortesa/GP2_vjcortesa_check errors.R/functions"
script_path <- rstudioapi::getActiveDocumentContext()$path
function_path <- file.path(dirname(script_path),"functions")
dataset_path <- file.path(dirname(dirname(script_path)),"Datasets")
# Load required functions
print(dataset_path)
source(file.path(function_path, "Combine_csvs_to_excel_function_vjcortesa.R"))
source(file.path(function_path, "Read_all_csvs_function_vjcortesa.R"))
# Get the path of the current script (works in RStudio),
# For example,  ".../R data analysis BEPs/Scripts_vjcortesa/GP2_vjcortesa_check errors.R/functions"
script_path <- rstudioapi::getActiveDocumentContext()$path
function_path <- file.path(dirname(script_path),"functions")
dataset_path <- file.path(dirname(dirname(script_path)),"Datasets")
# Load required functions
source(file.path(function_path, "Combine_csvs_to_excel_function_vjcortesa.R"))
source(file.path(function_path, "Read_all_csvs_function_vjcortesa.R"))
# Read the database folder to create accordingly the dataframe tables
folder_name <- "housinggame_session_20_251007_VerzekeraarsMasterClass"
# Set the Dataset folder path dynamically
# Read all tables in the folder with the custom function
csv_data_list <- read_all_csvs(dataset_path, folder_name)
# Create a combined excel with all database tables to have as a reference their initial configuration
combine_csvs_to_excel(dataset_path,folder_name)
# Assign a table to a variable in the global environment
gamesession <- csv_data_list[["gamesession"]]
group <- csv_data_list[["group"]]
groupround <- csv_data_list[["groupround"]]
playerround <- csv_data_list[["playerround"]]
player <- csv_data_list[["player"]]
# Rename the session name variable in the dataframe to avoid name overlap with the group name variable
gamesession <- sqldf("SELECT * FROM gamesession")
names(gamesession)[names(gamesession) == "name"] <- "gamesession_name"
View(gamesession)
# Assign a table to a variable in the global environment
gamesession <- csv_data_list[["gamesession"]]
group <- csv_data_list[["group"]]
groupround <- csv_data_list[["groupround"]]
playerround <- csv_data_list[["playerround"]]
player <- csv_data_list[["player"]]
# Rename the session name variable in the dataframe to avoid name overlap with the group name variable
gamesession <- sqldf("SELECT * FROM gamesession")
names(gamesession)[names(gamesession) == "name"] <- "gamesession_name"
# Add to the group dataframe the gamesession_name by the group = gamesession id
# Leftjoin Keeps only the rows that have matching values in both data frames
group <- sqldf("
SELECT g.*, gs.gamesession_name
FROM [group] AS g
LEFT JOIN [gamesession] AS gs
ON g.gamesession_id = gs.id
")
group <- sqldf("
SELECT g.*, gs.gamesession_name
FROM [group] AS g
LEFT JOIN [gamesession] AS gs
ON g.gamesession_id = gs.id
")
# Add to groupround the group variables selection
groupround <- sqldf("
SELECT gr.*, g.name, g.gamesession_id, g.gamesession_name, g.scenario_id
FROM [groupround] AS gr
LEFT JOIN [group] AS g
ON gr.group_id = g.id
")
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP2_vjcortesa_check errors.R")
# Add to playerround the groupround selection to filter per round, group and session id and names by playerround = groupround id
playerround <- sqldf("
SELECT pr.*, gr.round_number, gr.group_id, gr.group_name, gr.gamesession_id, gr.gamesession_name, gr.group_scenario_id
FROM [playerround] AS pr
LEFT JOIN [groupround] AS gr
ON pr.groupround_id = gr.id
")
# Rename name variable in the groupround dataframe for variable naming consistency
groupround <- sqldf("SELECT * FROM groupround")
# Rename the added columns in the dataframe to know from which table first come from
names(groupround)[names(groupround) == "name"] <- "group_name"
# Add to playerround the groupround selection to filter per round, group and session id and names by playerround = groupround id
playerround <- sqldf("
SELECT pr.*, gr.round_number, gr.group_id, gr.group_name, gr.gamesession_id, gr.gamesession_name, gr.group_scenario_id
FROM [playerround] AS pr
LEFT JOIN [groupround] AS gr
ON pr.groupround_id = gr.id
")
# Rename the added columns in the dataframe to know from which table first come from
names(playerround)[names(playerround) == "round_number"] <- "groupround_round_number"
names(playerround)[names(playerround) == "scenario_id"] <- "group_scenario_id"
# Rename id with the table prefix to avoid id ambiguity
#names(player)[names(player) == "id"] <- "player_id"
names(playerround)[names(playerround) == "id"] <- "playerround_id"
# Select the variables for the income distribution plot
var_income_dist <- c(
"playerround_id", "player_id", "groupround_id", "groupround_round_number",
"round_income", "living_costs", "paid_debt",
"profit_sold_house", "spent_savings_for_buying_house",
"cost_taxes", "mortgage_payment",
"cost_house_measures_bought", "cost_personal_measures_bought",
"cost_fluvial_damage", "cost_pluvial_damage",
"spendable_income"
)
# Collapse the column vector into a comma-separated string
col_income_dist <- paste(var_income_dist, collapse = ", ")
# Run the query to filter the playerround dataframe and add the player code
df_income_dist <- sqldf(paste0("
SELECT ", col_income_dist, ", p.code
FROM playerround
LEFT JOIN player AS p
ON player_id = p.id
"))
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP2_vjcortesa_check errors.R")
# Calculate the spendable income
df_income_dist$calculated_spendable <- df_income_dist$spendable_income
for (i in 1:nrow(df_income_dist)) {
if (df_income_dist$groupround_round_number[i] != "0") {
df_income_dist$calculated_spendable[i] <- sum(df_income_dist$calculated_spendable[i-1],
df_income_dist$round_income[i],
df_income_dist$profit_sold_house[i],
-df_income_dist$calculated_costs[i],
na.rm = TRUE)   }
}
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP2_vjcortesa_check errors.R")
View(df_income_dist)
list_income_dist <- list(
df_income_dist = df_income_dist,
gamesession = gamesession,
group = group,
groupround = groupround,
player = player,
playerround = playerround
)
# Step 3: Income distribution specification ---------------------------------------------------
# Create a list with the tables used in the calculation
list_income_dist <- list(
df_income_dist = df_income_dist,
gamesession = gamesession,
group = group,
groupround = groupround,
player = player,
playerround = playerround
)
session_name <- folder_name
group <- "all"
round <- "all"
dataset <- df_income_dist
# Calcule the reference dataset with all players average
## mapply safely substracts ingnoring NAs in either column
## na.rm = TRUE remove or ignore NA (missing) values when performing calculations.
dataset$income_minus_living<- mapply(
function(income, cost) sum(income, -cost, na.rm = TRUE),
dataset$round_income,
dataset$living_costs
)
dataset$profit_minus_spent_savings_house_moving <- mapply(
function(profit, spent) sum(profit, -spent, na.rm = TRUE),
dataset$profit_sold_house,
dataset$spent_savings_for_buying_house
)
#Reference dataset to draw area and line
income_dist_plt_ref <- dataset %>%
group_by(round_income) %>%
summarise(
ave_income_minus_living = round(mean(income_minus_living, na.rm = TRUE), 2),
ave_Spendable = round(mean(spendable_income, na.rm = TRUE), 2)
)
# Calculate the number of players per round income
if (round != "all") {
income_dist_x <- dataset %>% filter(groupround_round_number == round)
} else {
income_dist_x <- dataset %>% filter(groupround_round_number == "0")
}
# Calculate the number of players per round income
if (round != "all") {
income_dist_x <- dataset %>% filter(groupround_round_number == round)
} else {
income_dist_x <- dataset %>% filter(groupround_round_number == "0")
}
View(income_dist_x)
View(income_dist_x)
# Calculate the number of players per round 0 per income unless other round is defined
if (round != "all") {
income_dist_x <- dataset %>% filter(groupround_round_number == round)
} else {
income_dist_x <- dataset %>% filter(groupround_round_number == "0")
}
income_dist_x <- income_dist_x %>% count(round_income, name = "players_count")
income_dist_x <- income_dist_x %>% count(round_income, name = "players_count")
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP2_vjcortesa_check errors.R")
View(income_dist_x)
# Filter the dataset with all players plot
plot_player_all <- data.frame(p_code = c("t1p1", "t1p2", "t1p3", "t1p4", "t1p5", "t1p6" , "t1p7"),
selected = c(1, 1, 1, 1, 1, 1, 1))
# Filter the dataset with all players plot
plot_player_all <- data.frame(p_code = c("t1p1", "t1p2", "t1p3", "t1p4", "t1p5", "t1p6" , "t1p7"),
selected = c(1, 1, 1, 1, 1, 1, 1))
players <- plot_player_all
player_plot <- ""
if (nplayer == nrow(players)) {
player_plot = "all"
}
players <- plot_player_all
player_plot <- ""
# Filter the dataset according to the players to plot
for (i in 1:nrow(players)) {
if (players$selected[i] != "0") {
if (nchar(player_plot) == 0) {
player_plot <- players$p_code[i]
nplayer <- 1
fdataset <- dataset %>% filter(p_code == players$p_code[i])
} else {
player_plot <- paste(player_plot, "-", players$p_code[i])
nplayer <- nplayer +1
fdataset <- rbind(fdataset, dataset[dataset$p_code == players$p_code[i], ])
}
}
}
if (nplayer == nrow(players)) {
player_plot = "all"
}
# Filter the dataset according to the player(s) to plot
income_dist <- fdataset
# Plot title definition
plot_title <- "How did players spend their money in average?"
plot_subtitle <- paste("Session:", session_name, "\nGroup:", group, "\nPlayer(s):", player_plot, "\nRound:", round)
plot_name <- paste("IncomeDistribution_","Session_",session_name, "Group_", group, "Player_", player_plot,"Round_", round,".png")
income_dist_plt <- income_dist %>%
group_by(round_income) %>%
summarise(
ave_income_minus_living = round(mean(income_minus_living, na.rm = TRUE), 2),
ave_profit_minus_spent_savings_house_moving = round(mean(profit_minus_spent_savings_house_moving, na.rm = TRUE), 2),
ave_mortgage = round(mean(mortgage_payment, na.rm = TRUE), 2),
ave_taxes = round(mean(cost_taxes, na.rm = TRUE), 2),
ave_debt = round(mean(paid_debt, na.rm = TRUE), 2),
ave_measures = round(mean(cost_house_measures_bought, na.rm = TRUE), 2),
ave_satisfaction = round(mean(cost_personal_measures_bought, na.rm = TRUE), 2),
ave_fluvial_damage  = round(mean(cost_fluvial_damage, na.rm = TRUE), 2),
ave_pluvial_damage = round(mean(cost_pluvial_damage, na.rm = TRUE), 2),
ave_Spendable = round(mean(spendable_income, na.rm = TRUE), 2)
) %>%
ungroup()
View(list_income_dist)
View(income_dist_plt)
# Categorise the income distribution per plot category
line_spendable = income_dist_plt_ref %>% select(ave_Spendable)
bars_expenses <- income_dist_plt %>% select(ave_debt, ave_mortgage, ave_taxes, ave_profit_minus_spent_savings_house_moving, ave_satisfaction, ave_measures, ave_fluvial_damage, ave_pluvial_damage)
area_income <- income_dist_plt_ref %>% select(ave_income_minus_living)
# Adding an index to plot the area and bars together
line_spendable$Index <- seq_len(nrow(line_spendable))
bars_expenses$Index <- seq_len(nrow(bars_expenses))
area_income$Index <- seq_len(nrow(area_income))
View(line_spendable)
# Formatting the dataset to plot per category
bars_expenses_formatted <- bars_expenses %>%
pivot_longer(cols = -Index, names_to = "Type", values_to = "Value")
area_income_formatted <- area_income %>%
pivot_longer(cols = -Index, names_to = "Type", values_to = "Value")
View(area_income_formatted)
# Formatting the dataset to stack the bars following the given order
bars_expenses_formatted$Type <- factor(
bars_expenses_formatted$Type,
levels = c(
"ave_satisfaction",
"ave_fluvial_damage",
"ave_pluvial_damage",
"ave_measures",
"ave_debt",
"ave_taxes",
"ave_mortgage",
"ave_profit_minus_spent_savings_house_moving"
)
)
plot <- ggplot() +
geom_area(data = area_income_formatted,
aes(x = Index, y = Value, fill = Type),
alpha = 0.6
) +
geom_bar(data = bars_expenses_formatted,
aes(x = Index, y = Value, fill = Type),
stat = "identity",
position = "stack",
width = w
) +
geom_line(
data = line_spendable,
aes(x = Index,
y = ave_Spendable,
color = "ave_Spendable"),
linewidth = 1.2) +
labs(
title = plot_title,
subtitle = plot_subtitle,
color = "Category"
) +
# Custom fill colors to what is plotted in the legend
scale_color_manual(
name = "Round Spendable \n Income",
values = c(
"ave_Spendable" = "black"),
labels = c(
"ave_Spendable" = "Round income - costs")
) +
scale_fill_manual(
name = "Round costs",
values = c(
"ave_income_minus_living" = "#E1BB70",
"ave_debt" = "black",
"ave_satisfaction" = "#dfaba3",
"ave_measures" = "white",
"ave_profit_minus_spent_savings_house_moving" =  "#a3a3a3",
"ave_mortgage" = "#cccccc",
"ave_taxes" = "#dddddd",
"ave_fluvial_damage" = "#79A2C5",
"ave_pluvial_damage" = "#79BCC5"),
labels = c(
"ave_income_minus_living" = "Income - Living costs",
"ave_debt" = "Debt",
"ave_satisfaction" = "Satisfaction",
"ave_measures" = "Measures",
"ave_mortgage" = "Mortgage",
"ave_profit_minus_spent_savings_house_moving" = "House profit - Spent savings",
"ave_taxes" = "Taxes",
"ave_fluvial_damage" = "River damage",
"ave_pluvial_damage" = "Rain damage")
) +
guides(
fill = guide_legend(title = "Round costs"),
color = guide_legend(title = "Round Spendable Income")
) +
#Y-axis formatting
scale_y_continuous(
labels = function(y) y / 1000,
name = "Game Currency (k)"
) +
scale_x_continuous(
name = "Round income (k) \n Players per class",
breaks = c(1, 2, 3, 4, 5, 6),
labels = income_dist_x$label
) +
theme_minimal() +
theme(
axis.text.x = element_markdown(angle = 0, hjust = 0.5), ##takes rich html
plot.title = element_text(hjust = 0.5),
plot.subtitle = element_text(hjust = 0.5, size = 10),
plot.title.position = "plot"
)
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP2_vjcortesa_check errors.R")
plot <- ggplot() +
geom_area(data = area_income_formatted,
aes(x = Index, y = Value, fill = Type),
alpha = 0.6
) +
geom_bar(data = bars_expenses_formatted,
aes(x = Index, y = Value, fill = Type),
stat = "identity",
position = "stack",
width = w
) +
geom_line(
data = line_spendable,
aes(x = Index,
y = ave_Spendable,
color = "ave_Spendable"),
linewidth = 1.2) +
labs(
title = plot_title,
subtitle = plot_subtitle,
color = "Category"
) +
# Custom fill colors to what is plotted in the legend
scale_color_manual(
name = "Round Spendable \n Income",
values = c(
"ave_Spendable" = "black"),
labels = c(
"ave_Spendable" = "Round income - costs")
) +
scale_fill_manual(
name = "Round costs",
values = c(
"ave_income_minus_living" = "#E1BB70",
"ave_debt" = "black",
"ave_satisfaction" = "#dfaba3",
"ave_measures" = "white",
"ave_profit_minus_spent_savings_house_moving" =  "#a3a3a3",
"ave_mortgage" = "#cccccc",
"ave_taxes" = "#dddddd",
"ave_fluvial_damage" = "#79A2C5",
"ave_pluvial_damage" = "#79BCC5"),
labels = c(
"ave_income_minus_living" = "Income - Living costs",
"ave_debt" = "Debt",
"ave_satisfaction" = "Satisfaction",
"ave_measures" = "Measures",
"ave_mortgage" = "Mortgage",
"ave_profit_minus_spent_savings_house_moving" = "House profit - Spent savings",
"ave_taxes" = "Taxes",
"ave_fluvial_damage" = "River damage",
"ave_pluvial_damage" = "Rain damage")
) +
guides(
fill = guide_legend(title = "Round costs"),
color = guide_legend(title = "Round Spendable Income")
) +
#Y-axis formatting
scale_y_continuous(
labels = function(y) y / 1000,
name = "Game Currency (k)"
) +
scale_x_continuous(
name = "Round income (k) \n Players per class",
breaks = c(1, 2, 3, 4, 5, 6),
labels = income_dist_x$label
) +
theme_minimal() +
theme(
axis.text.x = element_markdown(angle = 0, hjust = 0.5), ##takes rich html
plot.title = element_text(hjust = 0.5),
plot.subtitle = element_text(hjust = 0.5, size = 10),
plot.title.position = "plot"
)
ggsave(plot_name, width = 12, height = 6, dpi = 300)
plot(plot)
print(getwd())
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP2_vjcortesa_check errors.R")
print(script_path)
script_path <- dirname(rstudioapi::getActiveDocumentContext()$path)
function_path <- file.path(script_path,"functions")
dataset_path <- file.path(dirname(script_path),"Datasets")
data_output_path <- file.path(script_path,"data_output")
fig_output_path <- file.path(script_path,"fig_output")
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP2_vjcortesa_check errors.R")
ggsave(
file.path(data_output_path,"myplot.png"),
plot = plot,
width = 12,
height = 6,
dpi = 300)
plot(plot)
print(plot_name)
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP2_vjcortesa_check errors.R")
ggsave(
file.path(fig_output_path,"myplot.png"),
plot = plot,
width = 12,
height = 6,
dpi = 300)
print(plot_name)
ggsave(
file.path(fig_output_path,plot_name),
plot = plot,
width = 12,
height = 6,
dpi = 300)
View(gamesession)
dataset_name <- str_extract(folder_name, "\\d+")
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP2_vjcortesa_check errors.R")
View(fdataset)
View(fdataset)
View(fdataset)
View(gamesession)
print(gamesession$gamesession_name)
dataset_name <- str_extract(gamesession$gamesession_name, "\\d+")
print(gamesession$gamesession_name)
print(dataset_name)
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP2_vjcortesa_How did players spend their money_check errors.R")
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP2_vjcortesa_How did players spend their money_check errors.R")
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP2_vjcortesa_How did players spend their money_check errors.R")
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP2_vjcortesa_check errors.R")
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP2_vjcortesa_check errors.R")
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP2_vjcortesa_check errors.R")
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP2_vjcortesa_check errors.R")
# Write to Excel with sheet names matching table names
write_xlsx(list_income_dist, "folder_name_income_dist.xlsx")
tryCatch({
write_xlsx(list_income_dist, file.path(data_output_path, paste0("Income_dist_", folder_name, ".xlsx")))
message("File written successfully.")
}, error = function(e) {
message("Error: ", e$message)
})
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP2_vjcortesa_check errors.R")
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP2_vjcortesa_check errors.R")
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP2_vjcortesa_check errors.R")
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP3_vjcortesa_Selected measures_plotexample.R")
source("~/TUDelft/18_Game Data Analysis/R data analysis BEPs/Scripts_vjcortesa/GP3_vjcortesa_Selected measures_plotexample.R")
>>>>>>> ca769c527e0b91e58914c5a922abfb19a7b9f934
